name: Release and Publish Packages

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - major
          - minor
          - patch
  # Uncomment to auto-release on every push to main:
  # push:
  #   branches:
  #     - main

permissions:
  contents: write
  packages: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      release_version: ${{ steps.version.outputs.release_version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v3

      - name: Extract and prepare release version
        id: version
        run: |
          set -e

          # Get current version from build.gradle.kts (handles optional leading whitespace)
          CURRENT_VERSION=$(grep -E '^\s*version\s*=\s*"' build.gradle.kts | sed 's/.*version\s*=\s*"\([^"]*\)".*/\1/')

          if [ -z "$CURRENT_VERSION" ]; then
            echo "ERROR: Could not extract version from build.gradle.kts"
            exit 1
          fi
          echo "Current version: $CURRENT_VERSION"

          # Strip -SNAPSHOT to get release version
          RELEASE_VERSION=${CURRENT_VERSION%-SNAPSHOT}

          # Validate version format (X.Y.Z)
          if ! echo "$RELEASE_VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "ERROR: Invalid version format '$RELEASE_VERSION'. Expected X.Y.Z"
            exit 1
          fi

          echo "Release version: $RELEASE_VERSION"
          echo "release_version=$RELEASE_VERSION" >> $GITHUB_OUTPUT

          # Update build.gradle.kts to release version (remove -SNAPSHOT)
          sed -i 's/version = ".*"/version = "'$RELEASE_VERSION'"/' build.gradle.kts

          # Commit release version
          git add build.gradle.kts
          git commit -m "Release version $RELEASE_VERSION"
          git push origin HEAD:main

      - name: Build packages
        run: ./gradlew clean build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: build/
          retention-days: 1

  release-maven:
    runs-on: ubuntu-latest
    needs: prepare

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v3

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: build/

      - name: Publish Java package to GitHub Packages
        run: ./gradlew publish
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release-npm:
    runs-on: ubuntu-latest
    needs: prepare

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: build/

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Configure npm for GitHub Packages
        working-directory: build/typescript-package
        run: |
          echo "@elliotJHarding:registry=https://npm.pkg.github.com" >> .npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" >> .npmrc

      - name: Build and publish TypeScript package
        working-directory: build/typescript-package
        run: npm install && npm run build && npm publish

  release-python:
    runs-on: ubuntu-latest
    needs: prepare

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: build/

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build tools
        run: pip install build

      - name: Build wheel
        working-directory: build/python-package
        run: python -m build

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-wheel
          path: build/python-package/dist/*.whl
          retention-days: 1

  finalize:
    runs-on: ubuntu-latest
    needs: [prepare, release-maven, release-npm, release-python]
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Download Python wheel
        uses: actions/download-artifact@v4
        with:
          name: python-wheel
          path: dist/

      - name: Create Git Tag
        run: |
          RELEASE_VERSION="${{ needs.prepare.outputs.release_version }}"
          git tag "v$RELEASE_VERSION"
          git push origin "v$RELEASE_VERSION"

      - name: Create GitHub Release with wheel
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_VERSION="${{ needs.prepare.outputs.release_version }}"
          gh release create "v$RELEASE_VERSION" \
            --title "v$RELEASE_VERSION" \
            --generate-notes \
            dist/*.whl

      - name: Bump to next SNAPSHOT version
        run: |
          set -e

          RELEASE_VERSION="${{ needs.prepare.outputs.release_version }}"
          BUMP_TYPE="${{ inputs.bump_type || 'patch' }}"

          # Validate release version before processing
          if [ -z "$RELEASE_VERSION" ]; then
            echo "ERROR: Release version is empty"
            exit 1
          fi

          if ! echo "$RELEASE_VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "ERROR: Invalid release version format '$RELEASE_VERSION'. Expected X.Y.Z"
            exit 1
          fi

          echo "Release version: $RELEASE_VERSION"
          echo "Bump type: $BUMP_TYPE"

          # Split version into parts
          IFS='.' read -r MAJOR MINOR PATCH <<< "$RELEASE_VERSION"

          # Increment based on bump type
          if [ "$BUMP_TYPE" = "major" ]; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
          elif [ "$BUMP_TYPE" = "minor" ]; then
            MINOR=$((MINOR + 1))
            PATCH=0
          else
            PATCH=$((PATCH + 1))
          fi

          NEXT_VERSION="$MAJOR.$MINOR.$PATCH-SNAPSHOT"
          echo "Next version: $NEXT_VERSION"

          # Validate the computed next version
          if ! echo "$NEXT_VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+-SNAPSHOT$'; then
            echo "ERROR: Computed invalid next version '$NEXT_VERSION'"
            exit 1
          fi

          # Update build.gradle.kts to next SNAPSHOT version
          sed -i 's/version = ".*"/version = "'$NEXT_VERSION'"/' build.gradle.kts

          # Commit and push
          git add build.gradle.kts
          git commit -m "Bump version to $NEXT_VERSION"
          git push origin HEAD:main

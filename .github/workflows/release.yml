name: Release and Publish Packages

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Version bump type'
        required: true
        default: 'minor'
        type: choice
        options:
          - major
          - minor
          - patch
  # Uncomment to auto-release on every push to main:
  # push:
  #   branches:
  #     - main

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v3

      - name: Extract and prepare release version
        id: version
        run: |
          # Get current version from build.gradle.kts
          CURRENT_VERSION=$(grep '^version = ' build.gradle.kts | sed 's/version = "\(.*\)"/\1/')
          echo "Current version: $CURRENT_VERSION"

          # Strip -SNAPSHOT to get release version
          RELEASE_VERSION=${CURRENT_VERSION%-SNAPSHOT}
          echo "Release version: $RELEASE_VERSION"
          echo "release_version=$RELEASE_VERSION" >> $GITHUB_OUTPUT

          # Update build.gradle.kts to release version (remove -SNAPSHOT)
          sed -i 's/version = ".*"/version = "'$RELEASE_VERSION'"/' build.gradle.kts

          # Commit release version
          git add build.gradle.kts
          git commit -m "Release version $RELEASE_VERSION"

      - name: Build packages
        run: ./gradlew clean build

      - name: Publish Java package to GitHub Packages
        run: ./gradlew publish
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@elliotJHarding'

      - name: Build TypeScript package
        working-directory: build/typescript-package
        run: npm install && npm run build

      - name: Publish TypeScript package to GitHub Packages
        working-directory: build/typescript-package
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Git Tag
        run: |
          RELEASE_VERSION="${{ steps.version.outputs.release_version }}"
          git tag "v$RELEASE_VERSION"
          git push origin "v$RELEASE_VERSION"

      - name: Bump to next SNAPSHOT version
        run: |
          RELEASE_VERSION="${{ steps.version.outputs.release_version }}"
          BUMP_TYPE="${{ inputs.bump_type || 'minor' }}"

          # Split version into parts
          IFS='.' read -r MAJOR MINOR PATCH <<< "$RELEASE_VERSION"

          # Increment based on bump type
          if [ "$BUMP_TYPE" = "major" ]; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
          elif [ "$BUMP_TYPE" = "minor" ]; then
            MINOR=$((MINOR + 1))
            PATCH=0
          else
            PATCH=$((PATCH + 1))
          fi

          NEXT_VERSION="$MAJOR.$MINOR.$PATCH-SNAPSHOT"
          echo "Next version: $NEXT_VERSION"

          # Update build.gradle.kts to next SNAPSHOT version
          sed -i 's/version = ".*"/version = "'$NEXT_VERSION'"/' build.gradle.kts

          # Commit and push
          git add build.gradle.kts
          git commit -m "Bump version to $NEXT_VERSION"
          git push origin HEAD:main
